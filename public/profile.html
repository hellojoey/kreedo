<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <link rel="stylesheet" href="styles.css">
  <script src="scripts.js" defer></script>
  <!-- Include Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCMs-xS6_NKJh2DKOeHnLY3NTTp_zUNCm0",
      authDomain: "kreedo-5659e.firebaseapp.com",
      projectId: "kreedo-5659e",
      storageBucket: "kreedo-5659e.appspot.com",
      messagingSenderId: "395650604091",
      appId: "1:395650604091:web:7804b0af807767f853d01e",
      measurementId: "G-WT40DT0QRP"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <header>
    <h1><a href="index.html" style="text-transform: lowercase;">kreedo</a></h1>
    <div class="header-right">
      <div class="hamburger-menu" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <main>
    <section id="userInfo" class="profile-section">
      <img id="profilePicture" src="default-profile-pic.png" alt="Profile Picture" class="profile-pic">
      <div class="profile-details">
        <h2 id="username" class="username">@username</h2>
        <p id="fullName" class="fullname">Full Name</p>
      </div>
    </section>
    <section class="links-section">
      <div class="link-bubble">Daily Questions</div>
      <div class="link-bubble greyed-out">Daily Readings</div>
      <div class="link-bubble">Cloudmaps</div>
      <div class="link-bubble">Logbook</div>
      <div class="link-bubble">Recommended Series</div>
    </section>
    <section class="profile-stats">
      <div class="stat">
        <p>total answers</p>
        <h3 id="totalAnswers">0</h3>
      </div>
      <div class="question-carousel">
        <!-- Fading questions from questions.csv will be displayed here -->
        <div id="questionDisplay" class="question-display"></div>
      </div>
      <div class="progress">
        <p>daily progress</p>
        <div class="progress-bar" id="progressBar">
          <!-- 50 small squares for progress -->
          ${[...Array(50)].map(() => '<span class="empty"></span>').join('')}
        </div>
        <button class="continue-button">CONTINUE</button>
      </div>
    </section>
    <section class="carousel-section">
      <h2>Trending Topics</h2>
      <div class="carousel">
        <div class="carousel-item">Topic 1</div>
        <div class="carousel-item">Topic 2</div>
        <div class="carousel-item">Topic 3</div>
        <!-- Add more topics as needed -->
      </div>
    </section>
    <section id="logbook">
      <h2>Logbook</h2>
      <input type="text" id="searchBar" placeholder="Search log...">
      <ul id="questionsList"></ul>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadUserProfile();
      loadQuestionsFromCSV();

      // Function to fetch and display user profile data
      function loadUserProfile() {
        const user = firebase.auth().currentUser;
        if (user) {
          const userDocRef = firebase.firestore().collection('users').doc(user.uid);
          userDocRef.get().then((doc) => {
            if (doc.exists) {
              const userData = doc.data();
              document.getElementById('username').textContent = `@${userData.username}`;
              document.getElementById('fullName').textContent = userData.fullName;
              document.getElementById('profilePicture').src = userData.profilePicture || 'default-profile-pic.png';
              document.getElementById('totalAnswers').textContent = userData.totalAnswers;
              updateProgressBar(userData.dailyProgress || 0);
              displayUserAnswers(userData.answers);
            } else {
              console.log('No such document!');
            }
          }).catch((error) => {
            console.log('Error getting document:', error);
          });
        } else {
          console.log('No user is signed in');
        }
      }

      // Function to display user answers
      function displayUserAnswers(answers) {
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = '';
        for (const questionID in answers) {
          const listItem = document.createElement('li');
          const answerData = answers[questionID];
          listItem.innerHTML = `
            <p>Question ${questionID}</p>
            <p>Current Answer: ${answerData.currentAnswer}</p>
            <p>History:</p>
            <ul>
              ${answerData.history.map(hist => `<li>${hist.answer} on ${new Date(hist.timestamp).toLocaleString()}</li>`).join('')}
            </ul>
            <button onclick="changeAnswer('${questionID}')">Change Answer</button>
          `;
          questionsList.appendChild(listItem);
        }
      }

      // Function to change answer
      window.changeAnswer = function(questionID) {
        const newAnswer = prompt("Enter new answer:");
        if (newAnswer) {
          saveUserAnswer(questionID, newAnswer);
        }
      }

      // Function to save user answer
      function saveUserAnswer(questionID, answer) {
        const user = firebase.auth().currentUser;
        if (user) {
          const userDocRef = firebase.firestore().collection('users').doc(user.uid);
          userDocRef.update({
            [`answers.${questionID}.currentAnswer`]: answer,
            [`answers.${questionID}.history`]: firebase.firestore.FieldValue.arrayUnion({ answer: answer, timestamp: new Date().toISOString() })
          }).then(() => {
            loadUserProfile();
          }).catch((error) => {
            console.error('Error saving answer: ', error);
          });
        } else {
          console.error('No user is signed in');
        }
      }

      // Function to update progress bar
      function updateProgressBar(progress) {
        const progressBar = document.getElementById('progressBar');
        progressBar.innerHTML = '';
        for (let i = 0; i < 50; i++) {
          const span = document.createElement('span');
          span.className = i < progress ? 'filled' : 'empty';
          progressBar.appendChild(span);
        }
      }

      // Function to load questions from questions.csv and start the fading effect
      function loadQuestionsFromCSV() {
        fetch('questions.csv')
          .then(response => response.text())
          .then(data => {
            const questions = Papa.parse(data, { header: true }).data;
            const questionDisplay = document.getElementById('questionDisplay');
            let currentIndex = 0;

            function showNextQuestion() {
              if (questions.length > 0) {
                questionDisplay.textContent = questions[currentIndex].Question; // Assuming 'Question' is the column name
                currentIndex = (currentIndex + 1) % questions.length;
                questionDisplay.classList.add('fade-in');
                setTimeout(() => {
                  questionDisplay.classList.remove('fade-in');
                  setTimeout(showNextQuestion, 1000);
                }, 3000);
              }
            }

            showNextQuestion();
          })
          .catch(error => console.error('Error loading questions:', error));
      }
    });
  </script>
</body>
</html>
